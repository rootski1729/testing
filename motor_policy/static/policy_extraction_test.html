<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Policy Extraction Tester</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 2rem; }
    h1 { font-size: 1.25rem; margin-bottom: 1rem; }
    .card { border: 1px solid #ccc; border-radius: 8px; padding: 1rem; max-width: 720px; }
    .row { display: flex; gap: 0.75rem; margin-bottom: 0.75rem; flex-wrap: wrap; }
    .row label { min-width: 140px; font-weight: 600; }
    input[type="text"], input[type="file"], select, textarea { flex: 1; padding: 0.5rem; border: 1px solid #bbb; border-radius: 6px; }
    textarea { min-height: 200px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; }
    button { padding: 0.6rem 1rem; border: 0; border-radius: 6px; background: #2f6fed; color: #fff; cursor: pointer; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .muted { color: #666; font-size: 0.9rem; }
    .status { margin: 0.5rem 0 0.75rem; font-size: 0.95rem; }
    .row .hint { font-size: 0.8rem; color: #666; flex-basis: 100%; margin-left: 140px; }
    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; }
    .small { font-size: 0.85rem; }
  </style>
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const warn = document.getElementById('originWarn');
      if (location.protocol === 'file:') {
        warn.textContent = 'You are opening this file directly (origin is null). Please serve it via http://localhost:8000/static/motor_policy/policy_extraction_test.html to avoid CORS issues.';
        warn.style.display = 'block';
      }
    });
    async function runExtraction(e) {
      e.preventDefault();
      const baseUrl = document.getElementById('baseUrl').value.replace(/\/$/, '');
      const auth = document.getElementById('auth').value.trim();
      const fileInput = document.getElementById('file');
      const statusEl = document.getElementById('status');
      const outEl = document.getElementById('output');

      outEl.value = '';
      statusEl.textContent = '';

      if (!fileInput.files || fileInput.files.length === 0) {
        alert('Please choose a file.');
        return;
      }
      const file = fileInput.files[0];
      const fileName = file.name || 'policy.pdf';
      const contentType = file.type || 'application/pdf';

      try {
        setStatus('Requesting presigned upload URL...');
        const presignedResp = await fetch(`${baseUrl}/motor-policy/policy/policy-presigned-url/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(auth ? { 'Authorization': auth } : {}),
          },
          body: JSON.stringify({ file_name: fileName, content_type: contentType }),
        });
        if (!presignedResp.ok) throw await explainError(presignedResp);
        const { upload_url, file_url } = await presignedResp.json();

        setStatus('Uploading file to S3...');
        const putResp = await fetch(upload_url, {
          method: 'PUT',
          headers: { 'Content-Type': contentType },
          body: file,
        });
        if (!putResp.ok) throw await explainError(putResp);

        setStatus('Triggering extraction...');
        const extractResp = await fetch(`${baseUrl}/motor-policy/policy/upload-policy/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(auth ? { 'Authorization': auth } : {}),
          },
          body: JSON.stringify({ url: file_url }),
        });
        if (!extractResp.ok) throw await explainError(extractResp);
        const result = await extractResp.json();

        setStatus('Done.');
        outEl.value = JSON.stringify(result, null, 2);
      } catch (err) {
        setStatus('Error: ' + (err && err.message ? err.message : err));
      }

      function setStatus(msg) {
        statusEl.textContent = msg;
      }

      async function explainError(resp) {
        let bodyText = '';
        try { bodyText = await resp.text(); } catch {}
        const snippet = bodyText ? ` Body: ${bodyText.substring(0, 500)}` : '';
        return new Error(`HTTP ${resp.status} ${resp.statusText}.${snippet}`);
      }
    }
  </script>
</head>
<body>
  <div class="card">
    <h1>Policy Extraction Tester</h1>
    <p class="muted">Runs: policy_presigned_url → upload to S3 → upload_policy</p>
    <p id="originWarn" style="display:none;color:#b00020;font-weight:600"></p>

    <form onsubmit="runExtraction(event)">
      <div class="row">
        <label for="baseUrl">Base URL</label>
        <input id="baseUrl" type="text" value="http://localhost:8000" />
        <div class="hint small">Example: http://localhost:8000</div>
      </div>
      <div class="row">
        <label for="auth">Auth Header</label>
        <input id="auth" type="text" placeholder="Authorization header, e.g., Bearer eyJ..." />
        <div class="hint small">Paste full Authorization header value here</div>
      </div>
      <div class="row">
        <label for="file">Policy File</label>
        <input id="file" type="file" accept=".pdf,image/*" />
        <div class="hint small">PDF or image files are supported</div>
      </div>
      <div class="row">
        <button type="submit">Run Extraction</button>
        <span id="status" class="status"></span>
      </div>
      <div class="row">
        <label for="output">Result</label>
        <textarea id="output" readonly placeholder="Extraction response will appear here..."></textarea>
      </div>
    </form>
  </div>
</body>
</html>
